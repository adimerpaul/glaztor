import{Q as _,a as b}from"./QSelect.7f7f9668.js";import{S as V,T as g,U as y,V as i,W as l,aD as f,Y as a,X as h,a1 as M,a2 as U,a3 as Q,Z as p,aF as v,aE as x,b0 as S,aG as k,_ as C}from"./index.8e5efdfb.js";import{Q as T}from"./QMarkupTable.f4b57dd0.js";import{Q as I}from"./QForm.4421addc.js";import{Q as Y}from"./QPage.8f9149b4.js";import{h as m}from"./moment.40bc58bf.js";import{m as w}from"./vue3-apexcharts.0cc51cdb.js";import{_ as F}from"./plugin-vue_export-helper.21dcd24c.js";import"./format.7d90d4c2.js";m.locale("es");const O={name:"Metas",components:{apexchart:w},data(){return{series:[],chartOptions:{chart:{type:"bar",height:350},plotOptions:{bar:{horizontal:!1,columnWidth:"55%",endingShape:"rounded"}},dataLabels:{enabled:!0},xaxis:{categories:[]},title:{text:"Metas y Toneladas por Usuario",align:"center"}},metasCemento:[],meta:"",users:[],user:"",dialogMeta:!1,meses:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],mes:"",anios:[],anio:m().format("YYYY"),loading:!1,usersMeta:[]}},mounted(){console.log(m().format("M"));for(let t=-5;t<6;t++)this.anios.push(parseInt(this.anio)+t);let o=m().format("M")-1;this.mes=this.meses[o],this.getMetas(),this.getUsers()},methods:{updateChart(){const o=this.usersMeta.map(n=>n.name),t=this.usersMeta.map(n=>parseInt(n.pivot.meta||0)),c=this.usersMeta.map(n=>parseInt(n.sumaToneladas||0)),r=t.map(n=>100 .toFixed(1)),s=this.usersMeta.map(n=>{const d=n.pivot.meta;return(n.sumaToneladas*100/d).toFixed(1)});this.series=[{name:"Meta",data:t,percentages:r},{name:"Toneladas",data:c,percentages:s}],this.chartOptions={...this.chartOptions,xaxis:{...this.chartOptions.xaxis,categories:o},dataLabels:{enabled:!0,formatter:function(n,d){const u=d.seriesIndex===0?r:s;return`${n} (${u[d.dataPointIndex]}%)`}}}},updateMeta(o,t,c){console.log(o,t,c),this.$axios.put(`metasCemento/${c}`,{meta:o,user_id:t}).then(r=>{this.$alert.success("Meta actualizada")}).catch(r=>{this.$alert.error(r.response.data.message)})},saveMeta(){if(this.user==="")return this.$alert.error("Seleccione un usuario"),!1;this.loading=!0,this.$axios.post("metasCemento",{mes:this.mes,anio:this.anio,user_id:this.user}).then(o=>{this.dialogMeta=!1,this.getMetas()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},addMeta(){this.mes=this.meses[m().format("M")-1],this.anio=m().format("YYYY"),this.user="",this.dialogMeta=!0},getMetasUser(){if(this.meta==="")return this.$alert.error("Seleccione una gesti\xF3n"),!1;this.loading=!0,this.$axios.get(`metasCemento/${this.meta}`).then(o=>{var t;this.usersMeta=(t=o.data)==null?void 0:t.users,this.updateChart()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},getUsers(){this.$axios.get("users").then(o=>{this.users=o.data}).catch(o=>{console.log(o)})},getMetas(){this.metasCemento=[],this.loading=!0,this.$axios.get("metasCemento").then(o=>{o.data.forEach(t=>{this.metasCemento.push({id:t.id,name:`${t.mes} ${t.anio}`,...t}),this.meta.length===0&&(this.meta=this.metasCemento[this.metasCemento.length-1].id,this.getMetasUser())})}).catch(o=>{console.log(o)}).finally(()=>{this.loading=!1})}}},A={class:"row"},q=a("div",{class:"col-12 bg-black text-white q-pa-xs text-bold text-center"}," Metas Cemento ",-1),B={class:"col-6 col-md-3"},D={class:"col-6 col-md-3 text-center"},E={class:"col-6 col-md-6 text-right"},L={class:"col-12"},N=a("thead",null,[a("tr",null,[a("th",null,"Usuario"),a("th",null,"Meta"),a("th",null,"Logrado"),a("th",null,"Faltante")])],-1),P={style:{width:"120px"}},z={class:"text-right"},G={class:"text-right"},J=a("td",{class:"text-bold text-right"},"Total",-1),W={class:"text-bold"},X={class:"col-12 q-pa-xs"},Z=a("div",{class:"col-12"},null,-1),j=a("div",{class:"text-h6"},"Agregar Meta",-1);function H(o,t,c,r,s,n){const d=V("apexchart");return g(),y(Y,{class:"bg-grey-3 q-pa-xs"},{default:i(()=>[l(v,null,{default:i(()=>[l(f,{class:"q-pa-xs"},{default:i(()=>[a("div",A,[q,a("div",B,[l(_,{modelValue:s.meta,"onUpdate:modelValue":t[0]||(t[0]=e=>s.meta=e),options:s.metasCemento,label:"Gesti\xF3n",outlined:"",dense:"",rules:[e=>e!==null||"Seleccione una gesti\xF3n"],"option-value":"id","option-label":"name","emit-value":"","map-options":""},null,8,["modelValue","options","rules"])]),a("div",D,[l(h,{color:"primary",label:"Consultar",onClick:n.getMetasUser,"no-caps":"",icon:"search",loading:s.loading},null,8,["onClick","loading"])]),a("div",E,[l(h,{color:"green",label:"Agregar",onClick:n.addMeta,"no-caps":"",icon:"add",loading:s.loading},null,8,["onClick","loading"])]),a("div",L,[l(T,{dense:"","wrap-cells":""},{default:i(()=>[N,a("tbody",null,[(g(!0),M(Q,null,U(s.usersMeta,e=>(g(),M("tr",{key:e.id},[a("td",null,p(e.name),1),a("td",P,[a("div",null,[l(x,{modelValue:e.pivot.meta,"onUpdate:modelValue":[u=>e.pivot.meta=u,u=>n.updateMeta(e.pivot.meta,e.pivot.user_id,e.pivot.meta_id)],outlined:"",dense:"",type:"number",debounce:"500"},null,8,["modelValue","onUpdate:modelValue"])])]),a("td",z,[l(b,{color:"primary",class:"text-white bg-green-8"},{default:i(()=>[C(p(e.sumaToneladas),1)]),_:2},1024)]),a("td",G,[l(b,{color:"primary",class:"text-white bg-red-8"},{default:i(()=>[C(p(e.pivot.meta-e.sumaToneladas),1)]),_:2},1024)])]))),128))]),a("tfoot",null,[a("tr",null,[J,a("td",W,p(s.usersMeta.reduce((e,u)=>e+parseInt(u.pivot.meta),0)),1)])])]),_:1})]),a("div",X,[l(d,{type:"bar",height:"350",options:s.chartOptions,series:s.series},null,8,["options","series"])]),Z])]),_:1})]),_:1}),l(k,{modelValue:s.dialogMeta,"onUpdate:modelValue":t[5]||(t[5]=e=>s.dialogMeta=e)},{default:i(()=>[l(v,null,{default:i(()=>[l(I,{onSubmit:n.saveMeta},{default:i(()=>[l(f,{class:"q-pa-xs"},{default:i(()=>[j]),_:1}),l(f,null,{default:i(()=>[l(x,{modelValue:s.mes,"onUpdate:modelValue":t[1]||(t[1]=e=>s.mes=e),label:"Mes",outlined:"",dense:"",options:s.meses,rules:[e=>e!==null||"Seleccione un mes"]},null,8,["modelValue","options","rules"]),l(x,{modelValue:s.anio,"onUpdate:modelValue":t[2]||(t[2]=e=>s.anio=e),label:"A\xF1o",outlined:"",dense:"",options:s.anios,rules:[e=>e!==null||"Seleccione un a\xF1o"]},null,8,["modelValue","options","rules"]),l(_,{modelValue:s.user,"onUpdate:modelValue":t[3]||(t[3]=e=>s.user=e),options:s.users,label:"Usuario",outlined:"",dense:"",rules:[e=>e!==null||"Seleccione un usuario"],"option-value":"id","option-label":"name","emit-value":"","map-options":""},null,8,["modelValue","options","rules"])]),_:1}),l(S,{align:"right"},{default:i(()=>[l(h,{label:"Cancelar",color:"primary",flat:"",onClick:t[4]||(t[4]=e=>s.dialogMeta=!1),loading:s.loading},null,8,["loading"]),l(h,{label:"Guardar",color:"primary",flat:"",type:"submit",loading:s.loading},null,8,["loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])]),_:1})}var ne=F(O,[["render",H]]);export{ne as default};
