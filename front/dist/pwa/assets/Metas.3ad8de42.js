import{Q as _,a as b}from"./QSelect.c8fcec14.js";import{Q as y,R as g,S as C,T as n,U as l,aA as f,W as a,V as h,$ as M,a0 as Q,a1 as U,Z as p,aC as v,aB as x,a_ as S,aD as T,Y as V}from"./index.8bd998ce.js";import{Q as k}from"./QMarkupTable.c2c12e36.js";import{Q as I}from"./QForm.8105f686.js";import{Q as Y}from"./QPage.f0d189ce.js";import{h as c}from"./moment.40bc58bf.js";import{m as A}from"./vue3-apexcharts.a7675078.js";import{_ as O}from"./plugin-vue_export-helper.21dcd24c.js";import"./format.3ef389eb.js";c.locale("es");const w={name:"Metas",components:{apexchart:A},data(){return{series:[],chartOptions:{chart:{type:"bar",height:350},plotOptions:{bar:{horizontal:!1,columnWidth:"55%",endingShape:"rounded"}},dataLabels:{enabled:!0},xaxis:{categories:[]},title:{text:"Metas y Toneladas por Usuario",align:"center"}},metas:[],meta:"",users:[],user:"",dialogMeta:!1,meses:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],mes:"",anios:[],anio:c().format("YYYY"),loading:!1,usersMeta:[]}},mounted(){for(let t=-5;t<6;t++)this.anios.push(parseInt(this.anio)+t);let o=c().format("M")-1;this.mes=this.meses[o],this.getMetas(),this.getUsers()},methods:{updateChart(){const o=this.usersMeta.map(i=>i.name),t=this.usersMeta.map(i=>parseInt(i.pivot.meta||0)),m=this.usersMeta.map(i=>parseInt(i.sumaToneladas||0)),r=t.map(i=>100 .toFixed(1)),s=this.usersMeta.map(i=>{const d=i.pivot.meta;return(i.sumaToneladas*100/d).toFixed(1)});this.series=[{name:"Meta",data:t,percentages:r},{name:"Toneladas",data:m,percentages:s}],this.chartOptions={...this.chartOptions,xaxis:{...this.chartOptions.xaxis,categories:o},dataLabels:{enabled:!0,formatter:function(i,d){const u=d.seriesIndex===0?r:s;return`${i} (${u[d.dataPointIndex]}%)`}}}},updateMeta(o,t,m){console.log(o,t,m),this.$axios.put(`metas/${m}`,{meta:o,user_id:t}).then(r=>{this.$alert.success("Meta actualizada")}).catch(r=>{this.$alert.error(r.response.data.message)})},saveMeta(){if(this.user==="")return this.$alert.error("Seleccione un usuario"),!1;this.loading=!0,this.$axios.post("metas",{mes:this.mes,anio:this.anio,user_id:this.user}).then(o=>{this.dialogMeta=!1,this.getMetas()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},addMeta(){this.mes=this.meses[c().format("M")-1],this.anio=c().format("YYYY"),this.user="",this.dialogMeta=!0},getMetasUser(){if(this.meta==="")return this.$alert.error("Seleccione una gesti\xF3n"),!1;this.loading=!0,this.$axios.get(`metas/${this.meta}`).then(o=>{var t;this.usersMeta=(t=o.data)==null?void 0:t.users,this.updateChart()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},getUsers(){this.$axios.get("users").then(o=>{this.users=o.data}).catch(o=>{console.log(o)})},getMetas(){this.metas=[],this.loading=!0,this.$axios.get("metas").then(o=>{o.data.forEach(t=>{this.metas.push({id:t.id,name:`${t.mes} ${t.anio}`,...t}),this.meta.length===0&&(this.meta=this.metas[this.metas.length-1].id,this.getMetasUser())})}).catch(o=>{console.log(o)}).finally(()=>{this.loading=!1})}}},B={class:"row"},F={class:"col-6 col-md-3"},q={class:"col-6 col-md-3 text-center"},D={class:"col-6 col-md-6 text-right"},L={class:"col-12"},N=a("thead",null,[a("tr",null,[a("th",null,"Usuario"),a("th",null,"Meta"),a("th",null,"Logrado"),a("th",null,"Faltante")])],-1),P={style:{width:"120px"}},z={class:"text-right"},E={class:"text-right"},G=a("td",{class:"text-bold text-right"},"Total",-1),J={class:"text-bold"},W={class:"col-12 q-pa-xs"},R=a("div",{class:"col-12"},null,-1),Z=a("div",{class:"text-h6"},"Agregar Meta",-1);function j(o,t,m,r,s,i){const d=y("apexchart");return g(),C(Y,{class:"bg-grey-3 q-pa-xs"},{default:n(()=>[l(v,null,{default:n(()=>[l(f,{class:"q-pa-xs"},{default:n(()=>[a("div",B,[a("div",F,[l(_,{modelValue:s.meta,"onUpdate:modelValue":t[0]||(t[0]=e=>s.meta=e),options:s.metas,label:"Gesti\xF3n",outlined:"",dense:"",rules:[e=>e!==null||"Seleccione una gesti\xF3n"],"option-value":"id","option-label":"name","emit-value":"","map-options":""},null,8,["modelValue","options","rules"])]),a("div",q,[l(h,{color:"primary",label:"Consultar",onClick:i.getMetasUser,"no-caps":"",icon:"search",loading:s.loading},null,8,["onClick","loading"])]),a("div",D,[l(h,{color:"green",label:"Agregar",onClick:i.addMeta,"no-caps":"",icon:"add",loading:s.loading},null,8,["onClick","loading"])]),a("div",L,[l(k,{dense:"","wrap-cells":""},{default:n(()=>[N,a("tbody",null,[(g(!0),M(U,null,Q(s.usersMeta,e=>(g(),M("tr",{key:e.id},[a("td",null,p(e.name),1),a("td",P,[a("div",null,[l(x,{modelValue:e.pivot.meta,"onUpdate:modelValue":[u=>e.pivot.meta=u,u=>i.updateMeta(e.pivot.meta,e.pivot.user_id,e.pivot.meta_id)],outlined:"",dense:"",type:"number",debounce:"500"},null,8,["modelValue","onUpdate:modelValue"])])]),a("td",z,[l(b,{color:"primary",class:"text-white bg-green-8"},{default:n(()=>[V(p(e.sumaToneladas),1)]),_:2},1024)]),a("td",E,[l(b,{color:"primary",class:"text-white bg-red-8"},{default:n(()=>[V(p(e.pivot.meta-e.sumaToneladas),1)]),_:2},1024)])]))),128))]),a("tfoot",null,[a("tr",null,[G,a("td",J,p(s.usersMeta.reduce((e,u)=>e+parseInt(u.pivot.meta),0)),1)])])]),_:1})]),a("div",W,[l(d,{type:"bar",height:"350",options:s.chartOptions,series:s.series},null,8,["options","series"])]),R])]),_:1})]),_:1}),l(T,{modelValue:s.dialogMeta,"onUpdate:modelValue":t[5]||(t[5]=e=>s.dialogMeta=e)},{default:n(()=>[l(v,null,{default:n(()=>[l(I,{onSubmit:i.saveMeta},{default:n(()=>[l(f,{class:"q-pa-xs"},{default:n(()=>[Z]),_:1}),l(f,null,{default:n(()=>[l(x,{modelValue:s.mes,"onUpdate:modelValue":t[1]||(t[1]=e=>s.mes=e),label:"Mes",outlined:"",dense:"",options:s.meses,rules:[e=>e!==null||"Seleccione un mes"]},null,8,["modelValue","options","rules"]),l(x,{modelValue:s.anio,"onUpdate:modelValue":t[2]||(t[2]=e=>s.anio=e),label:"A\xF1o",outlined:"",dense:"",options:s.anios,rules:[e=>e!==null||"Seleccione un a\xF1o"]},null,8,["modelValue","options","rules"]),l(_,{modelValue:s.user,"onUpdate:modelValue":t[3]||(t[3]=e=>s.user=e),options:s.users,label:"Usuario",outlined:"",dense:"",rules:[e=>e!==null||"Seleccione un usuario"],"option-value":"id","option-label":"name","emit-value":"","map-options":""},null,8,["modelValue","options","rules"])]),_:1}),l(S,{align:"right"},{default:n(()=>[l(h,{label:"Cancelar",color:"primary",flat:"",onClick:t[4]||(t[4]=e=>s.dialogMeta=!1),loading:s.loading},null,8,["loading"]),l(h,{label:"Guardar",color:"primary",flat:"",type:"submit",loading:s.loading},null,8,["loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])]),_:1})}var le=O(w,[["render",j]]);export{le as default};
