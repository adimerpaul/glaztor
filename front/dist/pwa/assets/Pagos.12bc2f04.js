import{R as u,$ as b,U as o,T as i,aD as w,a1 as x,aC as P,aA as m,W as s,aB as p,V as f,S as v,Y as g,aE as y,a0 as F,Z as r,M as q,X as k}from"./index.e95100ec.js";import{d as C,e as _,a as Q}from"./format.39f6ce55.js";import{Q as N,a as z}from"./QSelect.b493f8f7.js";import{Q as S}from"./QList.cb00ee73.js";import{Q as T}from"./QPage.a2881a74.js";import{Q as V}from"./QSpace.5ba5662b.js";import{Q as Y}from"./QMarkupTable.92a4f163.js";import{Q as D}from"./QForm.c582a3d7.js";import{C as U}from"./ClosePopup.c6d1387a.js";import{h as E}from"./moment.40bc58bf.js";import{E as M}from"./Excel.343f1006.js";import{_ as A}from"./plugin-vue_export-helper.21dcd24c.js";import"./index.a93ba69a.js";import"./_commonjsHelpers.a26ce4be.js";const B={name:"Pedidos",data(){return{loading:!1,dialog:!1,clientes:[],fechaInicio:E().startOf("month").format("YYYY-MM-DD"),fechaFin:E().endOf("month").format("YYYY-MM-DD"),zonas:[],pedidos:[],productos:[],pedido:{producto_id:null},dialogPagos:!1,pago:{monto:"",forma_pago:"EFECTIVO",numero_recibo:"",banco:""}}},mounted(){this.getZonas(),this.getPedidos(),this.getClientes(),this.getProductos()},methods:{exportExcel(){let l=[];this.pedidos.forEach(n=>{n.detalles.forEach(h=>{var t;l.push({fecha:n.fecha,cliente:n.cliente,producto:h.producto.nombre_pro,cantidad:h.cantidad,precio:h.precio,subtotal:h.cantidad*h.precio,factura:n.factura,nombre_factura:n.nombre_factura,nit_factura:n.nit_factura,direccion:n.direccion,contacto:n.contacto,telefono:n.telefono,telefono2:n.telefono2,observacion:n.observacion,chofer:n.chofer,zona:n.zona,total:n.total,estado:n.estado,fecha_pago:n.fecha_pago,user:(t=n.user)==null?void 0:t.name})})});let a=[{sheet:"Cobranza",columns:[{label:"Fecha",value:"fecha"},{label:"Cliente",value:"cliente"},{label:"Producto",value:"producto"},{label:"Cantidad",value:"cantidad"},{label:"Precio",value:"precio"},{label:"Direccion",value:"direccion"},{label:"Observacion",value:"observacion"},{label:"Zona",value:"zona"},{label:"Total",value:"total"},{label:"Estado",value:"estado"},{label:"Fecha Pago",value:"fecha_pago"},{label:"User",value:"user"},{label:"Estado Credito",value:"estadoCredito"},{label:"Total Pagado",value:"totalPagado"},{label:"Pagos",value:"pagosRealizados"}],content:l}];M.export(a,"Reporte de Cobranzas")},showPago(l){const a=this.$store.user;a.role==="Administrador"||a.role==="Ventas"||a.role==="Cobranza"||a.role==="Director"||a.role==="Supervisor"||(this.dialogPagos=!0,this.pago={...l})},updatePago(l){console.log(l),this.$axios.put("pagos/"+l.id,l).then(a=>{this.$alert.success("Pago actualizado correctamente"),this.getPedidos(),this.dialogPagos=!1,this.dialog=!1}).catch(a=>{console.log(a),this.$alert.error("Error al actualizar el pago")}).finally(()=>{this.loading=!1})},submitPago(){if(this.loading=!0,this.pago.id){this.updatePago(this.pago);return}this.$axios.post("pagos",{...this.pago,pedido_id:this.pedido.id}).then(l=>{this.dialogPagos=!1,this.$alert.success("Pago agregado correctamente"),this.pedido.pagos.push(l.data),this.getPedidos()}).catch(l=>{console.log(l),this.$alert.error("Error al agregar el pago")}).finally(()=>{this.loading=!1})},clickDialogPago(){this.dialogPagos=!0,this.pago={monto:"",forma_pago:"EFECTIVO",numero_recibo:"",banco:"",fecha_pago:E().format("YYYY-MM-DD")}},getZonas(){this.$axios.get("zonas").then(l=>{this.zonas=l.data}).catch(l=>{console.log(l)})},showPreventa(l){this.pedido={...l},this.dialog=!0},submit(){this.loading=!0,this.$axios.put("pedidos/"+this.pedido.id,this.pedido).then(l=>{this.dialog=!1,this.$alert.success("Pedido actualizado correctamente"),this.getPedidos()}).catch(l=>{console.log(l),this.$alert.error("Error al actualizar el pedido")}).finally(()=>{this.loading=!1})},getProductos(){this.$axios.get("productos").then(l=>{this.productos=l.data}).catch(l=>{console.log(l)})},getClientes(){this.$axios.get("clientes").then(l=>{this.clientes=l.data}).catch(l=>{console.log(l)})},addPedido(){this.$router.push({name:"pedidosPage"})},getPedidos(){this.loading=!0,this.$axios.get("pedidosEntregados",{params:{fechaInicio:this.fechaInicio,fechaFin:this.fechaFin}}).then(l=>{this.pedidos=l.data,this.loading=!1}).catch(l=>{console.log(l),this.loading=!1})}},computed:{esMovil(){return this.$q.screen.lt.md}}},R={class:"row"},O={class:"col-6 col-md-3"},Z={class:"col-6 col-md-3"},L={class:"col-6 col-md-2 text-left"},G={class:"col-6 col-md-4 text-right"},H={class:"text-h6"},W={class:"text-bold row items-center"},X={class:"text-bold q-pa-xs"},j=s("label",null,"Total",-1),J=s("thead",null,[s("tr",null,[s("th",null,"Fecha"),s("th",null,"Numero de Recibo"),s("th",null,"Banco"),s("th",null,"Subtotal")])],-1),K=["onClick"],$={class:"text-right"},ee={colspan:"2"},oe={class:"text-bold text-red"},te=s("td",{class:"text-right"},"Total",-1),le={class:"text-bold text-right"},ae={class:"text-h6"};function se(l,a,n,h,t,c){return u(),b(x,null,[o(T,{class:"bg-grey-3 q-pa-xs"},{default:i(()=>[o(P,null,{default:i(()=>[o(m,{class:"q-pa-xs"},{default:i(()=>[s("div",R,[s("div",O,[o(p,{outlined:"",modelValue:t.fechaInicio,"onUpdate:modelValue":a[0]||(a[0]=e=>t.fechaInicio=e),label:"Fecha Inicio",type:"date",color:"white",dense:""},null,8,["modelValue"])]),s("div",Z,[o(p,{outlined:"",modelValue:t.fechaFin,"onUpdate:modelValue":a[1]||(a[1]=e=>t.fechaFin=e),label:"Fecha Fin",type:"date",color:"white",dense:""},null,8,["modelValue"])]),s("div",L,[o(f,{icon:"search",color:"primary",label:"Buscar",onClick:c.getPedidos,loading:t.loading,"no-caps":""},null,8,["onClick","loading"])]),s("div",G,[o(f,{icon:"download",color:"green",label:"Exportar",onClick:c.exportExcel,"no-caps":""},null,8,["onClick"])])])]),_:1})]),_:1}),o(m,{class:"q-pa-none"},{default:i(()=>[o(S,{dense:"",class:"rounded-borders"},{default:i(()=>[t.pedidos.length===0?(u(),v(Q,{key:0},{default:i(()=>[o(C,null,{default:i(()=>[o(_,{class:"text-h6 text-grey"},{default:i(()=>[g("No hay pedidos")]),_:1})]),_:1})]),_:1})):y("",!0),(u(!0),b(x,null,F(t.pedidos,e=>(u(),v(Q,{key:e.id,onClick:d=>c.showPreventa(e),clickable:"",class:"q-my-sm bg-white hover-bg-light-blue",style:{border:"1px solid #e0e0e0","border-radius":"8px"}},{default:i(()=>[o(C,null,{default:i(()=>[o(_,{class:"text-h6"},{default:i(()=>[g(r(e.fecha.substring(0,10)||"Sin propietario")+" ",1),o(k,{name:"check_circle",color:e.estado==="PENDIENTE"?"red":e.estado==="ENTREGADO"?"green":"orange"},null,8,["color"])]),_:2},1024),o(_,{class:"text-subtitle1 text-grey"},{default:i(()=>[g(r(e.direccion)+" ",1),o(z,null,{default:i(()=>[g(r(e.total),1)]),_:2},1024),o(z,{color:e.totalPagado>=e.total?"positive":"negative",class:"text-white"},{default:i(()=>[g(r((e.total-e.pagos.reduce((d,I)=>d+parseFloat(I.monto),0)).toFixed(2)),1)]),_:2},1032,["color"])]),_:2},1024),o(_,{class:"text-caption text-positive"},{default:i(()=>{var d;return[g(r(e.cliente)+" - "+r(e.tipo_construccion)+" - "+r((d=e.user)==null?void 0:d.name)+" - "+r(e.fecha),1)]}),_:2},1024)]),_:2},1024),o(C,{side:""},{default:i(()=>[o(k,{name:"arrow_forward"})]),_:1})]),_:2},1032,["onClick"]))),128)),s("pre",null,r(t.pedidos),1)]),_:1})]),_:1})]),_:1}),o(w,{modelValue:t.dialog,"onUpdate:modelValue":a[2]||(a[2]=e=>t.dialog=e),position:c.esMovil?void 0:"right",maximized:!0,"transition-show":"slide-left","transition-hide":"slide-right"},{default:i(()=>[o(P,{style:{width:"450px","max-width":"100vw"}},{default:i(()=>[o(m,{class:"row items-center q-px-md bg-primary text-white q-px-none"},{default:i(()=>[q(o(f,{flat:"",round:"",dense:"",icon:"fa-solid fa-arrow-left"},null,512),[[U]]),o(V),s("div",H,r(t.pedido.id?"Editar":"Nuevo")+" Pedido",1)]),_:1}),o(m,null,{default:i(()=>[o(D,{onSubmit:c.submit},{default:i(()=>[s("div",W,[s("div",null,"Pagos de "+r(t.pedido.cliente),1),o(V),l.$store.user.role==="Cobranza"||l.$store.user.role==="Admin"?(u(),v(f,{key:0,size:"11px",icon:"add_circle_outline",color:"green",dense:"",label:"Agregar Pago",onClick:c.clickDialogPago,"no-caps":""},null,8,["onClick"])):y("",!0)]),s("div",X,[j,s("div",null,r(t.pedido.total),1)]),o(Y,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:i(()=>[J,s("tbody",null,[(u(!0),b(x,null,F(t.pedido.pagos,e=>(u(),b("tr",{key:e.id,onClick:d=>c.showPago(e)},[s("td",null,r(e.fecha_pago)+" "+r(e.hora_pago),1),s("td",null,r(e.numero_recibo),1),s("td",null,r(e.banco),1),s("td",$,r(e.monto),1)],8,K))),128))]),s("tfoot",null,[s("tr",null,[s("td",ee,[g(" Deuda "),s("span",oe,r((t.pedido.total-t.pedido.pagos.reduce((e,d)=>e+parseFloat(d.monto),0)).toFixed(2)),1)]),te,s("td",le,r(t.pedido.pagos.reduce((e,d)=>e+parseFloat(d.monto),0).toFixed(2)),1)])])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","position"]),o(w,{modelValue:t.dialogPagos,"onUpdate:modelValue":a[9]||(a[9]=e=>t.dialogPagos=e)},{default:i(()=>[o(P,{style:{width:"450px","max-width":"100vw"}},{default:i(()=>[o(m,{class:"row items-center q-px-md bg-primary text-white q-px-none"},{default:i(()=>[o(f,{flat:"",round:"",dense:"",icon:"fa-solid fa-arrow-left",onClick:a[3]||(a[3]=e=>t.dialogPagos=!1)}),o(V),s("div",ae,r(t.pago.id?"Editar":"Nuevo")+" Pago ",1)]),_:1}),o(m,null,{default:i(()=>[o(D,{onSubmit:c.submitPago},{default:i(()=>[o(p,{modelValue:t.pago.fecha_pago,"onUpdate:modelValue":a[4]||(a[4]=e=>t.pago.fecha_pago=e),outlined:"",label:"Fecha de Pago",type:"date",rules:[e=>!!e||"Campo requerido"],dense:""},null,8,["modelValue","rules"]),o(p,{modelValue:t.pago.monto,"onUpdate:modelValue":a[5]||(a[5]=e=>t.pago.monto=e),outlined:"",label:"Monto",type:"number",rules:[e=>!!e||"Campo requerido"],dense:""},null,8,["modelValue","rules"]),o(N,{modelValue:t.pago.forma_pago,"onUpdate:modelValue":a[6]||(a[6]=e=>t.pago.forma_pago=e),outlined:"",label:"Forma de Pago",dense:"",options:["EFECTIVO","TRANSFERENCIA","CHEQUE"],rules:[e=>!!e||"Campo requerido"]},null,8,["modelValue","rules"]),o(p,{modelValue:t.pago.numero_recibo,"onUpdate:modelValue":a[7]||(a[7]=e=>t.pago.numero_recibo=e),outlined:"",label:"N\xFAmero de Recibo",rules:[e=>!!e||"Campo requerido"],dense:""},null,8,["modelValue","rules"]),o(p,{modelValue:t.pago.banco,"onUpdate:modelValue":a[8]||(a[8]=e=>t.pago.banco=e),outlined:"",label:"Banco",dense:"",hint:""},null,8,["modelValue"]),o(f,{type:"submit",class:"full-width",label:t.pago.id?"Actualizar":"Agregar",color:t.pago.id?"primary":"green",loading:t.loading,"no-caps":""},null,8,["label","color","loading"])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var Pe=A(B,[["render",se]]);export{Pe as default};
