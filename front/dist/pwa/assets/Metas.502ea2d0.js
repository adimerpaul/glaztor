import{Q as _,a as x}from"./QSelect.b493f8f7.js";import{Q as y,R as p,S as C,T as i,U as l,aA as g,W as s,V as c,$ as b,a0 as Q,a1 as U,Z as r,aC as M,aB as f,a_ as S,aD as k,Y as v}from"./index.e95100ec.js";import{Q as T}from"./QMarkupTable.92a4f163.js";import{Q as Y}from"./QForm.c582a3d7.js";import{Q as A}from"./QPage.a2881a74.js";import{h as d}from"./moment.40bc58bf.js";import{m as O}from"./vue3-apexcharts.e3a708c0.js";import{_ as w}from"./plugin-vue_export-helper.21dcd24c.js";import"./format.39f6ce55.js";d.locale("es");const B={name:"Metas",components:{apexchart:O},data(){return{series:[],chartOptions:{chart:{type:"bar",height:350},plotOptions:{bar:{horizontal:!1,columnWidth:"55%",endingShape:"rounded"}},dataLabels:{enabled:!0},xaxis:{categories:[]},title:{text:"Metas y Toneladas por Usuario",align:"center"}},metas:[],meta:"",users:[],user:"",dialogMeta:!1,meses:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],mes:"",anios:[],anio:d().format("YYYY"),loading:!1,usersMeta:[]}},mounted(){for(let t=-5;t<6;t++)this.anios.push(parseInt(this.anio)+t);let o=d().format("M")-1;this.mes=this.meses[o],this.getMetas(),this.getUsers()},methods:{updateChart(){const o=this.usersMeta.map(n=>n.name),t=this.usersMeta.map(n=>parseInt(n.pivot.meta||0)),u=this.usersMeta.map(n=>parseInt(n.sumaToneladas||0));this.series=[{name:"Meta",data:t},{name:"Toneladas",data:u}],this.chartOptions={...this.chartOptions,xaxis:{...this.chartOptions.xaxis,categories:o}}},updateMeta(o,t,u){console.log(o,t,u),this.$axios.put(`metas/${u}`,{meta:o,user_id:t}).then(n=>{this.$alert.success("Meta actualizada")}).catch(n=>{this.$alert.error(n.response.data.message)})},saveMeta(){if(this.user==="")return this.$alert.error("Seleccione un usuario"),!1;this.loading=!0,this.$axios.post("metas",{mes:this.mes,anio:this.anio,user_id:this.user}).then(o=>{this.dialogMeta=!1,this.getMetas()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},addMeta(){this.mes=this.meses[d().format("M")-1],this.anio=d().format("YYYY"),this.user="",this.dialogMeta=!0},getMetasUser(){if(this.meta==="")return this.$alert.error("Seleccione una gesti\xF3n"),!1;this.loading=!0,this.$axios.get(`metas/${this.meta}`).then(o=>{var t;this.usersMeta=(t=o.data)==null?void 0:t.users,this.updateChart()}).catch(o=>{this.$alert.error(o.response.data.message)}).finally(()=>{this.loading=!1})},getUsers(){this.$axios.get("users").then(o=>{this.users=o.data}).catch(o=>{console.log(o)})},getMetas(){this.metas=[],this.loading=!0,this.$axios.get("metas").then(o=>{o.data.forEach(t=>{this.metas.push({id:t.id,name:`${t.mes} ${t.anio}`,...t}),this.meta.length===0&&(this.meta=this.metas[this.metas.length-1].id,this.getMetasUser())})}).catch(o=>{console.log(o)}).finally(()=>{this.loading=!1})}}},I={class:"row"},q={class:"col-6 col-md-3"},D={class:"col-6 col-md-3 text-center"},F={class:"col-6 col-md-6 text-right"},N={class:"col-12"},z=s("thead",null,[s("tr",null,[s("th",null,"Usuario"),s("th",null,"Meta"),s("th",null,"Logrado"),s("th",null,"Faltante")])],-1),E={style:{width:"120px"}},L={class:"text-right"},G={class:"text-right"},J=s("td",{class:"text-bold text-right"},"Total",-1),W={class:"text-bold"},P={class:"col-12 q-pa-xs"},R=s("div",{class:"col-12"},null,-1),Z=s("div",{class:"text-h6"},"Agregar Meta",-1);function j(o,t,u,n,a,m){const V=y("apexchart");return p(),C(A,{class:"bg-grey-3 q-pa-xs"},{default:i(()=>[l(M,null,{default:i(()=>[l(g,{class:"q-pa-xs"},{default:i(()=>[s("div",I,[s("div",q,[l(_,{modelValue:a.meta,"onUpdate:modelValue":t[0]||(t[0]=e=>a.meta=e),options:a.metas,label:"Gesti\xF3n",outlined:"",dense:"",rules:[e=>e!==null||"Seleccione una gesti\xF3n"],"option-value":"id","option-label":"name","emit-value":"","map-options":""},null,8,["modelValue","options","rules"])]),s("div",D,[l(c,{color:"primary",label:"Consultar",onClick:m.getMetasUser,"no-caps":"",icon:"search",loading:a.loading},null,8,["onClick","loading"])]),s("div",F,[l(c,{color:"green",label:"Agregar",onClick:m.addMeta,"no-caps":"",icon:"add",loading:a.loading},null,8,["onClick","loading"])]),s("div",N,[l(T,{dense:"","wrap-cells":""},{default:i(()=>[z,s("tbody",null,[(p(!0),b(U,null,Q(a.usersMeta,e=>(p(),b("tr",{key:e.id},[s("td",null,r(e.name),1),s("td",E,[s("div",null,[l(f,{modelValue:e.pivot.meta,"onUpdate:modelValue":[h=>e.pivot.meta=h,h=>m.updateMeta(e.pivot.meta,e.pivot.user_id,e.pivot.meta_id)],outlined:"",dense:"",type:"number",debounce:"500"},null,8,["modelValue","onUpdate:modelValue"])])]),s("td",L,[l(x,{color:"primary",class:"text-white bg-green-8"},{default:i(()=>[v(r(e.sumaToneladas),1)]),_:2},1024)]),s("td",G,[l(x,{color:"primary",class:"text-white bg-red-8"},{default:i(()=>[v(r(e.pivot.meta-e.sumaToneladas),1)]),_:2},1024)])]))),128))]),s("tfoot",null,[s("tr",null,[J,s("td",W,r(a.usersMeta.reduce((e,h)=>e+parseInt(h.pivot.meta),0)),1)])])]),_:1})]),s("div",P,[l(V,{type:"bar",height:"350",options:a.chartOptions,series:a.series},null,8,["options","series"])]),R])]),_:1})]),_:1}),l(k,{modelValue:a.dialogMeta,"onUpdate:modelValue":t[5]||(t[5]=e=>a.dialogMeta=e)},{default:i(()=>[l(M,null,{default:i(()=>[l(Y,{onSubmit:m.saveMeta},{default:i(()=>[l(g,{class:"q-pa-xs"},{default:i(()=>[Z]),_:1}),l(g,null,{default:i(()=>[l(f,{modelValue:a.mes,"onUpdate:modelValue":t[1]||(t[1]=e=>a.mes=e),label:"Mes",outlined:"",dense:"",options:a.meses,rules:[e=>e!==null||"Seleccione un mes"]},null,8,["modelValue","options","rules"]),l(f,{modelValue:a.anio,"onUpdate:modelValue":t[2]||(t[2]=e=>a.anio=e),label:"A\xF1o",outlined:"",dense:"",options:a.anios,rules:[e=>e!==null||"Seleccione un a\xF1o"]},null,8,["modelValue","options","rules"]),l(_,{modelValue:a.user,"onUpdate:modelValue":t[3]||(t[3]=e=>a.user=e),options:a.users,label:"Usuario",outlined:"",dense:"",rules:[e=>e!==null||"Seleccione un usuario"],"option-value":"id","option-label":"name","emit-value":"","map-options":""},null,8,["modelValue","options","rules"]),s("pre",null,r(a.mes),1),s("pre",null,r(a.anio),1),s("pre",null,r(a.user),1)]),_:1}),l(S,{align:"right"},{default:i(()=>[l(c,{label:"Cancelar",color:"primary",flat:"",onClick:t[4]||(t[4]=e=>a.dialogMeta=!1),loading:a.loading},null,8,["loading"]),l(c,{label:"Guardar",color:"primary",flat:"",type:"submit",loading:a.loading},null,8,["loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])]),_:1})}var le=w(B,[["render",j]]);export{le as default};
