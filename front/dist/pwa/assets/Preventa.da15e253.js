import{Q as _,R as n,$ as c,U as a,T as i,aD as U,a1 as v,aC as C,aA as f,W as r,V as d,_ as z,S as g,Y as h,aE as V,a0 as B,M as L,Z as p,aB as u,a_ as S,X as P}from"./index.472f576f.js";import{d as y,e as k,a as w}from"./format.6802d7a4.js";import{Q as x}from"./QList.c22e455d.js";import{Q as q}from"./QPage.76eee91d.js";import{Q as T}from"./QPageSticky.e99acd71.js";import{Q as D}from"./QSpace.20423384.js";import{Q as b}from"./QSelect.fd622edb.js";import{Q as N}from"./QForm.404e5d76.js";import{C as F}from"./ClosePopup.69a8fe43.js";import{h as O}from"./moment.40bc58bf.js";import{i as I,v as G,u as Y}from"./vue-leaflet.es.686531ec.js";import{E as R}from"./Excel.60733b5e.js";import{_ as Z}from"./plugin-vue_export-helper.21dcd24c.js";import"./index.8bd2ab55.js";const K={name:"Preventa",components:{LMap:I,LTileLayer:G,LMarker:Y},data(){return{tileProviders:[{name:"Mapa",visible:!0,url:"https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}",attribution:"&copy; Google Maps"},{name:"Satelite",visible:!1,url:"https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",attribution:"&copy; Google Maps"}],location:[-17.969753,-67.114749],zoom:15,propietarioBtnBool:!0,encargadoBtnBool:!0,preventas:[],preventa:{},dialog:!1,loading:!1,productosAll:[],products:[],marcas:[]}},mounted(){this.getPreventas(),this.getProductos()},methods:{exportExcel(){let e=[{sheet:"Preventas",columns:[{label:"Fecha",value:"fecha"},{label:"Propietario",value:"propietario"},{label:"Tel\xE9fono del propietario",value:"telefono_propietario"},{label:"Contratista",value:"contratista"},{label:"Tel\xE9fono del contratista",value:"telefono_contratista"},{label:"Direcci\xF3n",value:"direccion"},{label:"Ubicaci\xF3n",value:"ubicacion"},{label:"Zona",value:"zona"},{label:"Tipo de construcci\xF3n",value:"tipo_construccion"},{label:"Cantidad",value:"volumen"},{label:"Medida",value:"medida"},{label:"Marca",value:"marca"},{label:"Producto",value:"producto"},{label:"Observaci\xF3n",value:"observacion"}],content:this.preventas}];R.export(e,"Reporte de Prospecciones")},filterProducts(e){console.log(e),e!==null&&(this.products=this.productosAll.filter(o=>(o==null?void 0:o.marca_pro)===e))},getProductos(){this.$axios.get("productos").then(e=>{this.productosAll=e.data,this.products=this.productosAll,this.products.forEach(o=>{this.marcas.includes(o.marca_pro)||this.marcas.push(o.marca_pro)})}).catch(e=>{console.log(e)})},onMapClick(e){this.location=[e.latlng.lat,e.latlng.lng],this.preventa.ubicacion=`${e.latlng.lat.toFixed(7)}, ${e.latlng.lng.toFixed(7)}`},openGoogleMaps(){const[e,o]=this.preventa.ubicacion.split(",").map(Number);window.open(`https://www.google.com/maps/search/?api=1&query=${e},${o}`)},deletePreventa(e){this.$alert.dialog("\xBFDesea eliminar la preventa?").onOk(()=>{this.$axios.delete(`preventas/${e.id}`).then(()=>{this.preventas=this.preventas.filter(o=>o.id!==e.id),this.dialog=!1}).catch(o=>{console.log(o)})})},showPreventa(e){this.preventa=e,this.dialog=!0;const o=e.ubicacion.split(",").map(Number);console.log(o),this.location=o},onMarkerMoveEnd(e){const m=e.target.getLatLng();this.location=[m.lat,m.lng],this.preventa.ubicacion=`${m.lat.toFixed(7)}, ${m.lng.toFixed(7)}`},myLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{this.location=[e.coords.latitude,e.coords.longitude],this.preventa.ubicacion=`${e.coords.latitude}, ${e.coords.longitude}`})},submit(){this.preventa.id?this.updatePreventa():this.createPreventa()},updatePreventa(){this.loading=!0,this.$axios.put(`preventas/${this.preventa.id}`,this.preventa).then(()=>{const e=this.preventas.findIndex(o=>o.id===this.preventa.id);this.preventas.splice(e,1,this.preventa),this.dialog=!1}).catch(e=>{console.log(e)}).finally(()=>{this.loading=!1})},createPreventa(){this.loading=!0,this.$axios.post("preventas",this.preventa).then(e=>{this.preventas.unshift(e.data),this.dialog=!1}).catch(e=>{console.log(e)}).finally(()=>{this.loading=!1})},dialogClick(){this.dialog=!0,this.preventa={fecha:O().format("YYYY-MM-DD"),propietario:"",contratista:"",telefono_propietario:"",telefono_contratista:"",ubicacion:"-17.969753, -67.114749",zona:"",observacion:"",tipo_construccion:"",volumen:"",marca:"",direccion:""}},getPreventas(){this.$axios.get("preventas").then(e=>{this.preventas=e.data}).catch(e=>{console.log(e)})}},computed:{esMovil(){return this.$q.screen.lt.md}}},W=r("div",{class:"text-h5 text-primary"},"Lista de Preventas",-1),X={class:"text-h6"},j={class:"row"},H={class:"col-12"},J={class:"col-6 q-pa-xs"},$={class:"col-6 q-pa-xs"},ee={class:"col-12"},oe={class:"col-12"},le={class:"col-12"},te={class:"col-12"},ae={class:"col-12"},ie={class:"col-12"},re={style:{height:"250px",width:"100%"}},se={class:"div"},ne={class:"col-12"},de={class:"col-12"},ue={class:"col-12"},pe={class:"col-12"},me={class:"col-12"},ce={class:"col-12"},ve={class:"col-12"},be={class:"col-12"};function fe(e,o,m,ge,t,s){const M=_("l-tile-layer"),E=_("l-marker"),Q=_("l-map");return n(),c(v,null,[a(q,{class:"bg-grey-2 q-pa-md"},{default:i(()=>[a(C,{flat:"",bordered:"",class:"q-pa-md"},{default:i(()=>[a(f,null,{default:i(()=>[W,r("div",null,[a(d,{icon:"download",color:"green",label:"Exportar",onClick:s.exportExcel,"no-caps":""},null,8,["onClick"])])]),_:1}),a(z,{spaced:""}),a(f,{class:"q-pa-none"},{default:i(()=>[a(x,{dense:"",class:"rounded-borders"},{default:i(()=>[t.preventas.length===0?(n(),g(w,{key:0},{default:i(()=>[a(y,null,{default:i(()=>[a(k,{class:"text-h6 text-grey"},{default:i(()=>[h("No hay preventas")]),_:1})]),_:1})]),_:1})):V("",!0),(n(!0),c(v,null,B(t.preventas,l=>(n(),g(w,{key:l.id,onClick:A=>s.showPreventa(l),clickable:"",class:"q-my-sm bg-white hover-bg-light-blue",style:{border:"1px solid #e0e0e0","border-radius":"8px"}},{default:i(()=>[a(y,{avatar:""},{default:i(()=>[a(P,{name:"home",color:"grey",size:"md"})]),_:1}),a(y,null,{default:i(()=>[a(k,{class:"text-h6"},{default:i(()=>[h(p(l.propietario||"Sin propietario")+" "+p(l.telefono_propietario?`(${l.telefono_propietario})`:""),1)]),_:2},1024),a(k,{class:"text-subtitle1 text-grey"},{default:i(()=>[h(p(l.direccion),1)]),_:2},1024),a(k,{class:"text-caption text-positive"},{default:i(()=>{var A;return[h(p(l.zona)+" - "+p(l.tipo_construccion)+" - "+p((A=l.user)==null?void 0:A.name)+" - "+p(l.fecha),1)]}),_:2},1024)]),_:2},1024),a(y,{side:""},{default:i(()=>[a(P,{name:"arrow_forward"})]),_:1})]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1}),a(T,{position:"bottom-right",class:"text-bold",offset:[18,18]},{default:i(()=>[a(d,{fab:"",icon:"add",color:"primary",onClick:s.dialogClick},null,8,["onClick"])]),_:1}),a(U,{modelValue:t.dialog,"onUpdate:modelValue":o[18]||(o[18]=l=>t.dialog=l),position:s.esMovil?void 0:"right",maximized:!0,"transition-show":"slide-left","transition-hide":"slide-right"},{default:i(()=>[a(C,{style:{width:"450px","max-width":"100vw"}},{default:i(()=>[a(f,{class:"row items-center q-px-md bg-primary text-white q-px-none"},{default:i(()=>[L(a(d,{flat:"",round:"",dense:"",icon:"fa-solid fa-arrow-left"},null,512),[[F]]),a(D),r("div",X,p(t.preventa.id?"Editar":"Nueva")+" preventa",1)]),_:1}),a(f,null,{default:i(()=>[a(N,{onSubmit:s.submit},{default:i(()=>[r("div",j,[r("div",H,[a(u,{dense:"",modelValue:t.preventa.fecha,"onUpdate:modelValue":o[0]||(o[0]=l=>t.preventa.fecha=l),outlined:"",label:"Fecha",type:"date",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])]),r("div",J,[a(d,{label:"Propietario",outline:t.propietarioBtnBool,class:"full-width","no-caps":"",color:"primary",onClick:o[1]||(o[1]=l=>t.propietarioBtnBool=!t.propietarioBtnBool),disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["outline","disable"])]),r("div",$,[a(d,{label:"Encargado",outline:t.encargadoBtnBool,class:"full-width","no-caps":"",color:"primary",onClick:o[2]||(o[2]=l=>t.encargadoBtnBool=!t.encargadoBtnBool),disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["outline","disable"])]),t.propietarioBtnBool?V("",!0):(n(),c(v,{key:0},[r("div",ee,[a(u,{dense:"",modelValue:t.preventa.propietario,"onUpdate:modelValue":o[3]||(o[3]=l=>t.preventa.propietario=l),outlined:"",label:"Propietario",rules:[l=>!!l||"Este campo es requerido"],disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","rules","disable"])]),r("div",oe,[a(u,{dense:"",modelValue:t.preventa.telefono_propietario,"onUpdate:modelValue":o[4]||(o[4]=l=>t.preventa.telefono_propietario=l),outlined:"",label:"Telefono Propietario",type:"number",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])])],64)),t.encargadoBtnBool?V("",!0):(n(),c(v,{key:1},[r("div",le,[a(u,{dense:"",modelValue:t.preventa.contratista,"onUpdate:modelValue":o[5]||(o[5]=l=>t.preventa.contratista=l),outlined:"",label:"Encargado",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])]),r("div",te,[a(u,{dense:"",modelValue:t.preventa.telefono_contratista,"onUpdate:modelValue":o[6]||(o[6]=l=>t.preventa.telefono_contratista=l),outlined:"",label:"Telefono Encargado",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador",type:"number"},null,8,["modelValue","disable"])])],64)),r("div",ae,[a(u,{dense:"",modelValue:t.preventa.ubicacion,"onUpdate:modelValue":o[7]||(o[7]=l=>t.preventa.ubicacion=l),outlined:"",label:"Ubicacion",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},{append:i(()=>[a(d,{flat:"",icon:"fa-solid fa-map-marker-alt",onClick:s.myLocation},null,8,["onClick"])]),_:1},8,["modelValue","disable"])]),r("div",ie,[r("div",re,[r("div",se,[a(d,{icon:"my_location",color:"primary",onClick:s.openGoogleMaps,dense:"",flat:""},null,8,["onClick"])]),a(Q,{ref:"map",zoom:t.zoom,"onUpdate:zoom":o[8]||(o[8]=l=>t.zoom=l),"use-global-leaflet":!1,center:t.location,onClick:s.onMapClick},{default:i(()=>[(n(!0),c(v,null,B(t.tileProviders,l=>(n(),g(M,{key:l.name,name:l.name,visible:l.visible,url:l.url,attribution:l.attribution,"layer-type":"base"},null,8,["name","visible","url","attribution"]))),128)),a(E,{"lat-lng":t.location,onMoveend:s.onMarkerMoveEnd,ref:"marker",draggable:!0},null,8,["lat-lng","onMoveend"])]),_:1},8,["zoom","center","onClick"])])]),r("div",ne,[a(u,{dense:"",modelValue:t.preventa.direccion,"onUpdate:modelValue":o[9]||(o[9]=l=>t.preventa.direccion=l),outlined:"",label:"Direccion",rules:[l=>!!l||"Este campo es requerido"],disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","rules","disable"])]),r("div",de,[a(b,{dense:"",modelValue:t.preventa.zona,"onUpdate:modelValue":o[10]||(o[10]=l=>t.preventa.zona=l),options:["NORTE","ESTE","SUD","OESTE","CENTRO"],outlined:"",rules:[l=>!!l||"Este campo es requerido"],disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador",label:"Zona"},null,8,["modelValue","rules","disable"])]),r("div",ue,[a(b,{dense:"",modelValue:t.preventa.tipo_construccion,"onUpdate:modelValue":o[11]||(o[11]=l=>t.preventa.tipo_construccion=l),outlined:"",label:"Estado de la Obra","use-input":"",options:["Inicio Obra","Columnas","Muralla","Zapata","Sobrecimiento","Losa","Paralizada","Concluida"],disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])]),r("div",pe,[a(u,{dense:"",modelValue:t.preventa.volumen,"onUpdate:modelValue":o[12]||(o[12]=l=>t.preventa.volumen=l),outlined:"",label:"Cantidad",type:"number",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])]),r("div",me,[a(b,{dense:"",modelValue:t.preventa.medida,"onUpdate:modelValue":o[13]||(o[13]=l=>t.preventa.medida=l),outlined:"",label:"Medida","use-input":"",options:["Bar","Ton","Kg"],disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])]),r("div",ce,[a(b,{dense:"",modelValue:t.preventa.marca,"onUpdate:modelValue":[o[14]||(o[14]=l=>t.preventa.marca=l),s.filterProducts],outlined:"",label:"Marca","use-input":"",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador",options:t.marcas},null,8,["modelValue","onUpdate:modelValue","disable","options"])]),r("div",ve,[a(b,{dense:"",modelValue:t.preventa.producto,"onUpdate:modelValue":o[15]||(o[15]=l=>t.preventa.producto=l),outlined:"",label:"Producto","use-input":"","option-label":"nombre_pro","option-value":"nombre_pro","emit-value":"","map-options":"",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador",options:t.products},null,8,["modelValue","disable","options"])]),r("div",be,[a(u,{dense:"",modelValue:t.preventa.observacion,"onUpdate:modelValue":o[16]||(o[16]=l=>t.preventa.observacion=l),outlined:"",label:"Observacion",disable:e.$store.user.role!=="Admin"&&e.$store.user.role!=="Administrador"},null,8,["modelValue","disable"])]),e.$store.user.role==="Admin"||e.$store.user.role==="Administrador"?(n(),g(S,{key:2,align:"right"},{default:i(()=>[a(d,{label:"Cancelar",color:"negative",onClick:o[17]||(o[17]=l=>t.dialog=!1),loading:t.loading},null,8,["loading"]),a(d,{label:"Guardar",color:"primary",type:"submit",loading:t.loading},null,8,["loading"])]),_:1})):V("",!0)])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","position"])],64)}var ze=Z(K,[["render",fe]]);export{ze as default};
